<div class="min-h-screen">
  <div class="mx-auto">
    <!-- Add Transaction Button -->
    <div class="mb-6 flex items-center justify-between">
      <h2>Payments</h2>
      <button mat-raised-button color="primary" (click)="showNewTransactionForm()">
        <i class="fa fa-plus mr-3"></i> New Payment
      </button>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Bar Chart -->
      <mat-card class="card-shadow">
        <mat-card-header>
          <mat-card-title class="text-base md:text-lg">Monthly Collections</mat-card-title>
        </mat-card-header>
        <mat-card-content class="h-[250px] md:h-[300px]">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" type="bar">
          </canvas>
        </mat-card-content>
      </mat-card>

      <!-- Pie Chart -->
      <mat-card class="card-shadow">
        <mat-card-header>
          <mat-card-title class="text-base md:text-lg">Agent-wise Collections</mat-card-title>
        </mat-card-header>
        <mat-card-content class="h-[250px] md:h-[300px]">
          <canvas baseChart [data]="pieChartData" [options]="pieChartOptions" type="pie">
          </canvas>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Transaction Form -->
    <mat-card *ngIf="showForm" class="mb-6">
      <mat-card-content>
        <form (ngSubmit)="onSubmit()" class="grid grid-cols-2 gap-4">
          <mat-form-field>
            <mat-label>Select Agent</mat-label>
            <mat-select [(ngModel)]="selectedAgent" name="agent" required>
              <mat-option *ngFor="let agent of agents" [value]="agent">
                {{agent.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Select Client</mat-label>
            <mat-select [(ngModel)]="customerName" name="customerName" required>
             <mat-option *ngFor="let data of clientsData" value="data.id">{{data.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- <mat-form-field>
            <mat-label>Customer Name</mat-label>
            <input matInput [(ngModel)]="customerName" name="customerName" required>
          </mat-form-field> -->

          <mat-form-field>
            <mat-label>Payment Type</mat-label>
            <mat-select [(ngModel)]="selectedType" name="type" required>
              <mat-option value="Cash">Cash</mat-option>
              <mat-option value="Online">Online</mat-option>
              <mat-option value="Check">Check</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Amount</mat-label>
            <input matInput type="number" [(ngModel)]="amount" name="amount" required>
          </mat-form-field>

          <div class="col-span-2 flex justify-end gap-4">
            <button mat-button type="button" (click)="closeForm()">Cancel</button>
            <button mat-raised-button color="primary" type="submit">Save</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Agents Accordion -->
    <mat-accordion>
      <mat-expansion-panel *ngFor="let agent of agents" class="mb-2">
        <mat-expansion-panel-header class="bg-purple-300">
          <mat-panel-title>
            {{agent.name}}
          </mat-panel-title>
          <mat-panel-description class="justify-end">
            Total: ${{getAgentTotal(agent.transactions) | number:'1.2-2'}}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- Transaction List -->
        <div class="mt-4">
          <div class="grid grid-cols-1 gap-4">
            <div *ngFor="let transaction of agent.transactions" 
                 class="border rounded-lg p-4 hover:bg-gray-50">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-sm text-gray-600">{{transaction.date | date:'mediumDate'}}</p>
                  <p class="font-medium">{{transaction.customerName}}</p>
                  <p class="text-sm">Ref: {{transaction.reference}}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold">${{transaction.amount | number:'1.2-2'}}</p>
                  <p [class]="getPaymentTypeClass(transaction.type)" class="font-medium">
                    {{transaction.type}}
                  </p>
                  <span [class]="transaction.status === 'Completed' ? 'text-green-600' : 'text-orange-500'">
                    {{transaction.status}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>

<ng-template #transactionDialog>
  <h2 mat-dialog-title>New Payment</h2>
  <mat-dialog-content>
    <form [formGroup]="transactionForm" ngForm="transactionFormNew" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <mat-form-field>
        <mat-label>Select Agent</mat-label>
        <mat-select formControlName="agent">
          <mat-option *ngFor="let agent of agents" [value]="agent">{{agent.name}}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>Select Client</mat-label>
        <mat-select formControlName="customerName">
          <mat-option *ngFor="let data of clientsData" [value]="data.id">{{data.name}}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>Payment Type</mat-label>
        <mat-select formControlName="type">
          <mat-option value="cdm">CDM</mat-option>
          <mat-option value="bank">Bank</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>Amount</mat-label>
        <input matInput type="number" formControlName="amount">
      </mat-form-field>

    <div>
        <!-- Bank dropdown if type is Online -->
        <mat-form-field *ngIf="transactionForm.get('type')?.value === 'bank'" class="w-100">
          <mat-label>Select Bank</mat-label>
          <mat-select formControlName="bankName">
            <mat-option *ngFor="let bank of bankNames" [value]="bank">{{ bank }}</mat-option>
          </mat-select>
        </mat-form-field>
    </div>
      
     

      <!-- Denominations if type is CDM -->
   
        <div>
          <h3 class="text-lg font-semibold mb-2">Denominations</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <mat-form-field *ngFor="let denom of denominations">
            <mat-label>₹{{ denom }}</mat-label>
            <input matInput type="number" formControlName="denomination{{denom}}" >
            <mat-hint>Total: ₹</mat-hint>
          </mat-form-field>
        </div>
        <div class="text-right text-lg font-bold mt-2">
          Total: ₹
          <!-- {{ totalDenomination | number }} -->
        </div>
      </div>
      
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeDialog()">Cancel</button>
    <button mat-raised-button color="primary" (click)="saveTransaction()">
      Save
    </button>
  </mat-dialog-actions>
</ng-template>

